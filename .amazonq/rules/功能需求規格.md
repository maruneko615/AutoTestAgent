# 功能需求規格

## 功能概述
製作一個執行檔，使用 Q CLI 根據配置文件和 Protobuf Schema 生成 UDP 通訊程式，實現與 Unreal 遊戲的遠端操控。

## 需求分析
### 輸入文件
- `GameSetting\AutoTest_Game_Setting.md` - 遊戲設定配置
- `ProtoSchema\GameFlowData_pb2.py` - 遊戲流程數據 Python 類別
- `ProtoSchema\GameFlowData.proto` - 遊戲流程數據 Proto 定義
- `ProtoSchema\InputCommand_pb2.py` - 輸入指令 Python 類別  
- `ProtoSchema\InputCommand.proto` - 輸入指令 Proto 定義

### 通訊協定
- **接收**: 遊戲端傳送 `GameFlowData` (UDP)
- **發送**: 程式傳送 `InputCommand` 給遊戲 (UDP)
- **目標**: 實現遠端操控遊戲功能

## 完整工作流程

### 1. 遊戲開發階段
```
遊戲端人員
├── 依照格式製作 GameSetting\AutoTest_Game_Setting.md
├── 定義遊戲狀態、按鍵映射、選項內容
├── 使用 qcli_create_proto.bat 轉換成 proto 文件
└── 使用 protoc.exe 生成 GameFlowData_pb2.py 和 InputCommand_pb2.py
```

### 2. Agent 生成階段
```
AgentMaker (Q CLI 工具)
├── 讀取 GameSetting.md 配置
├── 分析 Protobuf Schema
├── 呼叫 Q CLI 生成程式碼
└── 輸出基礎版 AutoTestAgent.exe
```

### 3. 測試定制階段
```
測試人員 (透過雲端 Git Action)
├── 在專案 Git 倉庫下指令
├── 指定測試參數 (例: 某流程只使用特定 input)
├── 觸發 AutoTestBuilder 執行
└── 生成定制化的測試工具
```

### 4. 最終建置階段
```
AutoTestBuilder
├── 讀取測試人員的指令參數
├── 修改基礎版 AutoTestAgent
├── 注入特定的測試邏輯
└── 輸出最終的測試工具
```

## 實作細節

### 整體程式架構
```
AgentMaker (使用Q CLI製作功能的工具)
├── 讀取 GameSetting.md
├── 讀取 Protobuf Schema  
├── 分析遊戲邏輯需求
├── 呼叫 Q CLI 生成程式碼
└── 輸出 AutoTestAgent.exe

AutoTestAgent.exe (最終產出的遊戲控制程式)
├── 1. UDP 通訊模組 (UDPCommunicator)
│   ├── 建立 UDP Socket 連線
│   ├── 角色註冊機制 ("role:agent" → "ok:agent")
│   ├── 非同步訊息接收循環
│   ├── 接收 GameFlowData (Protobuf)
│   ├── 發送 InputCommand (Protobuf)
│   └── 連線錯誤處理與重連
├── 2. 遊戲狀態機 (GameStateMachine)
│   ├── 狀態匹配與分派
│   ├── 狀態處理器註冊
│   └── 狀態轉換邏輯
├── 3. 操作處理器 (ActionProcessor)
│   ├── 選項導航邏輯
│   ├── 按鍵序列生成
│   ├── 隨機輸入生成 (預設行為)
│   └── 目標達成檢測
└── 4. 主控制器 (MainController)
    ├── 模組協調
    ├── 錯誤處理
    ├── 即時日誌輸出
    │   ├── 接收訊息記錄 (GameFlowData)
    │   ├── 發送訊息記錄 (InputCommand)
    │   ├── 分隔線標記
    │   └── 同步輸出到檔案
    └── 日誌記錄
```

### 程式執行流程
```
1. 啟動階段
   ├── 初始化 Protobuf Schema
   ├── 建立 UDP Socket 連線
   └── 註冊狀態處理器

2. 運行階段 (循環)
   ├── 接收 GameFlowData
   ├── 記錄接收訊息 + 分隔線
   ├── 解析遊戲狀態
   ├── 匹配對應處理器
   ├── 生成操作指令
   ├── 發送 InputCommand
   ├── 記錄發送訊息 + 分隔線
   └── 同步日誌到檔案

3. 錯誤處理
   ├── 連線中斷重連
   ├── 訊息解析失敗
   ├── 狀態處理異常
   └── 優雅關閉程序
```

### 核心介面設計
```python
# 狀態處理器介面
class StateHandler:
    def can_handle(self, game_data) -> bool
    def process(self, game_data) -> InputCommand

# 主程式介面
class AutoTestAgent:
    def start_udp_server(self)
    def register_handlers(self)
    def run(self)
```

## 測試計畫
[待補充測試計畫]

---
建立時間: 2025-09-06
狀態: 需求分析完成
